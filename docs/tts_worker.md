# TTS 워커 (tts_worker.py)

## 개념
`tts_worker.py`는 **문장 단위 TTS 합성/재생을 큐로 비동기 처리**하는 워커다.  
메인 스레드는 텍스트 출력과 RAG 처리를 계속 진행하고, 워커 스레드는 TTS 합성/재생을 순차적으로 처리한다.

핵심 목적:
- 문장 단위 합성/재생을 **직렬화(큐)**해서 오디오가 섞이는 것을 방지
- 사용자 입력 중단 시 **즉시 재생 중단** 가능
- 문장별 합성 결과를 **세션 단위 단일 파일**로 누적 저장

---

## 현재 구현 요약
파일: `TextParsing/tts_worker.py`

- `TTSWorker` 클래스 하나로 구성
- 내부적으로 **queue.Queue** + **threading.Thread** 사용
- `infer_tts_onnx`로 오디오 생성
- `ffplay` 등 외부 플레이어 명령을 `subprocess.Popen`으로 실행
- 문장별 오디오를 **`soundfile.SoundFile`**로 세션 파일에 누적 기록

---

## queue.Queue와 threading.Thread 설명

### queue.Queue
- **스레드 안전한 FIFO 큐**다. 여러 스레드가 동시에 접근해도 데이터가 깨지지 않는다.
- `enqueue(sentence)`에서 문장을 넣으면, 워커 스레드가 `_run()`에서 하나씩 꺼낸다.
- 목적: **문장 합성/재생 순서를 보장**하고, 동시 실행으로 인한 오디오 겹침을 방지한다.

### threading.Thread
- 파이썬 프로세스 안에서 **백그라운드 작업을 병렬 실행**하는 스레드다.
- 워커 스레드가 TTS 합성과 재생을 수행하는 동안, 메인 스레드는 UI/출력 흐름을 계속 진행할 수 있다.
- 목적: **텍스트 출력과 TTS 합성을 분리**해 사용자 입력 반응성을 유지한다.

### 둘을 같이 쓰는 이유
- `Thread`만 쓰면 동시 요청이 섞일 수 있고, 순서 보장이 어렵다.
- `Queue`만 쓰면 메인 스레드를 막기 쉽다.
- 따라서 **큐로 순서를 보장하고, 스레드로 비동기 실행**하는 조합을 사용한다.

---

## 주요 동작 흐름
1. **초기화**
   - 모델 경로/디바이스/플레이어 설정 저장
   - ONNX config에서 샘플레이트 로드

2. **start()**
   - `out_dir` 생성
   - 세션 단일 파일(`tts_<uuid>.wav`)을 열어 누적 기록 시작
   - 워커 스레드 시작

3. **enqueue(sentence)**
   - 텍스트 문장을 큐에 넣음

4. **_run() (워커 스레드)**
   - 큐에서 문장을 꺼내 순차 처리
   - sanitize 함수로 정리
   - split 함수로 TTS용 분절
   - 각 세그먼트별로 `infer_tts_onnx` 실행
   - 재생(cmd 존재 시) + 세션 파일 누적 기록

5. **close()**
   - 종료 신호(None) 삽입
   - 큐/스레드 종료 대기
   - 파일 핸들 닫기

6. **cancel()**
   - 재생 중인 프로세스 강제 종료
   - 큐 비우기
   - 파일 핸들 닫기

---

## 출력 파일
- 문장별 생성 파일: `out_dir/tts_<uuid>.wav`
- 세션 누적 파일: `out_dir/tts_<uuid>.wav`
  - `start()`에서 열려 누적 기록됨

---

## 주요 메서드 설명

### `__init__(...)`
- 모델 경로, 디바이스, 플레이어, 텍스트 정제/분절 함수 저장
- 내부 큐/스레드/락/이벤트 초기화

### `start()`
- 세션 단일 파일을 열고 워커 시작

### `enqueue(sentence)`
- 텍스트 문장을 큐에 삽입

### `close()`
- 정상 종료용

### `cancel()`
- 사용자 새 질문 입력 시 **즉시 이전 TTS 중단**에 사용

### `last_path()`
- 마지막 생성된 wav 경로 반환

---

## 주의사항
- `cancel()`은 재생 프로세스를 강제 종료하므로, 재생 중단 시에만 사용
- `player_cmd`가 없으면 재생 없이 파일 저장만 수행
- 샘플레이트는 config 로드 실패 시 기본값 `22050` 사용

---

## 관련 의존성
- `soundfile`
- `tts_runtime.infer_onnx`
- `subprocess` (외부 플레이어 재생)
